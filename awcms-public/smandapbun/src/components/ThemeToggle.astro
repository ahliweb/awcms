---
import { Icon } from "astro-icon/components";
---

<button
  id="theme-toggle"
  type="button"
  class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center justify-center transition-colors duration-200 border border-transparent hover:border-gray-300 dark:hover:border-gray-600"
  aria-label="Toggle Dark Mode"
>
  <div id="theme-toggle-dark-icon" class="hidden">
    <Icon
      name="tabler:moon-filled"
      class="w-5 h-5 text-primary-600 dark:text-primary-300"
    />
  </div>
  <div id="theme-toggle-light-icon" class="hidden">
    <Icon name="tabler:sun-filled" class="w-5 h-5 text-secondary-400" />
  </div>
</button>

<script is:inline>
  // Function to handle theme toggling
  function setupThemeToggle() {
    const themeToggleDarkIcon = document.getElementById(
      "theme-toggle-dark-icon",
    );
    const themeToggleLightIcon = document.getElementById(
      "theme-toggle-light-icon",
    );
    const themeToggleBtn = document.getElementById("theme-toggle");

    if (!themeToggleBtn || !themeToggleDarkIcon || !themeToggleLightIcon) {
      return;
    }

    // Change the icons inside the button based on previous settings
    if (
      localStorage.getItem("color-theme") === "dark" ||
      (!("color-theme" in localStorage) &&
        window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      themeToggleLightIcon.classList.remove("hidden");
      themeToggleDarkIcon.classList.add("hidden");
      document.documentElement.classList.add("dark");
    } else {
      themeToggleLightIcon.classList.add("hidden");
      themeToggleDarkIcon.classList.remove("hidden");
      document.documentElement.classList.remove("dark");
    }

    // Remove old event listeners by cloning
    const newBtn = themeToggleBtn.cloneNode(true);
    themeToggleBtn.parentNode.replaceChild(newBtn, themeToggleBtn);

    // Re-select the new button and icons (since they were inside the cloned button)
    const activeBtn = document.getElementById("theme-toggle");
    const activeDarkIcon = document.getElementById("theme-toggle-dark-icon");
    const activeLightIcon = document.getElementById("theme-toggle-light-icon");

    activeBtn.addEventListener("click", function () {
      // toggle icons inside button
      activeDarkIcon.classList.toggle("hidden");
      activeLightIcon.classList.toggle("hidden");

      // if set via local storage previously
      if (localStorage.getItem("color-theme")) {
        if (localStorage.getItem("color-theme") === "light") {
          document.documentElement.classList.add("dark");
          localStorage.setItem("color-theme", "dark");
        } else {
          document.documentElement.classList.remove("dark");
          localStorage.setItem("color-theme", "light");
        }
      } else {
        if (document.documentElement.classList.contains("dark")) {
          document.documentElement.classList.remove("dark");
          localStorage.setItem("color-theme", "light");
        } else {
          document.documentElement.classList.add("dark");
          localStorage.setItem("color-theme", "dark");
        }
      }
    });
  }

  // Run immediately
  setupThemeToggle();

  // Support View Transitions
  document.addEventListener("astro:after-swap", setupThemeToggle);
</script>
