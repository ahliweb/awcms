---
import Layout from "../layouts/Layout.astro";
import { Icon } from "astro-icon/components";
import { getLocale, t, getLocalizedValue, type Locale } from "../utils/i18n";
import { getContactPageData, getTenantId } from "../lib/api";
import Toast from "../components/ui/Toast.astro";

const locale = getLocale(Astro.url) as Locale;

const contactData = await getContactPageData();
const tenantId = await getTenantId();
const { contactPage, contactInfo, socialMedia, mapEmbed } = contactData;

const siteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
console.log("Turnstile Site Key:", siteKey);
---

<Layout title={t("contact.title", locale)}>
  <Toast />
  <!-- Hero -->
  <section
    class="hero-gradient text-white py-16 md:py-24"
    style="--hero-image: url('/images/backgrounds/hero-campus.webp');"
    data-testid="contact-hero"
  >
    <div class="container-custom">
      <p class="text-secondary-300 font-medium mb-2">
        {t("nav.contact", locale)}
      </p>
      <h1 class="text-4xl md:text-5xl font-bold font-heading">
        {getLocalizedValue(contactPage.title, locale)}
      </h1>
      <p class="text-xl text-blue-100 mt-4 max-w-2xl">
        {getLocalizedValue(contactPage.description, locale)}
      </p>
    </div>
  </section>

  <!-- Contact Content -->
  <section
    class="section-photo py-16 bg-gray-50 dark:bg-slate-900 transition-colors duration-200"
    style="--section-image: url('/images/backgrounds/section-campus.webp');"
    data-testid="contact-content"
  >
    <div class="container-custom">
      <div class="grid lg:grid-cols-2 gap-12">
        <!-- Contact Info -->
        <div>
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
            {t("footer.contact_info", locale)}
          </h2>

          <div class="space-y-6">
            <div
              class="flex items-start gap-4 bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm transition-colors duration-200"
              data-testid="contact-address"
            >
              <div
                class="w-12 h-12 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center flex-shrink-0"
              >
                <Icon
                  name="tabler:map-pin"
                  class="w-6 h-6 text-primary-600 dark:text-primary-300"
                />
              </div>
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-1">
                  {t("contact.address", locale)}
                </h3>
                <p class="text-gray-600 dark:text-gray-300">
                  {getLocalizedValue(contactInfo.address, locale)}
                </p>
              </div>
            </div>

            <div
              class="flex items-start gap-4 bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm transition-colors duration-200"
              data-testid="contact-phone"
            >
              <div
                class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center flex-shrink-0"
              >
                <Icon
                  name="tabler:phone"
                  class="w-6 h-6 text-green-600 dark:text-green-400"
                />
              </div>
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-1">
                  {t("contact.phone", locale)}
                </h3>
                <p class="text-gray-600 dark:text-gray-300">
                  {contactInfo.phone}
                </p>
              </div>
            </div>

            <div
              class="flex items-start gap-4 bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm transition-colors duration-200"
              data-testid="contact-email"
            >
              <div
                class="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center flex-shrink-0"
              >
                <Icon
                  name="tabler:mail"
                  class="w-6 h-6 text-orange-600 dark:text-orange-400"
                />
              </div>
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-1">
                  {t("contact.email", locale)}
                </h3>
                <a
                  href={`mailto:${contactInfo.email}`}
                  class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300"
                  >{contactInfo.email}</a
                >
              </div>
            </div>

            <div
              class="flex items-start gap-4 bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm transition-colors duration-200"
              data-testid="contact-hours"
            >
              <div
                class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center flex-shrink-0"
              >
                <Icon
                  name="tabler:clock"
                  class="w-6 h-6 text-purple-600 dark:text-purple-400"
                />
              </div>
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-1">
                  {t("contact.hours", locale)}
                </h3>
                <p class="text-gray-600 dark:text-gray-300 whitespace-pre-line">
                  {getLocalizedValue(contactInfo.operationalHours, locale)}
                </p>
              </div>
            </div>
          </div>

          <!-- Social Media -->
          <div class="mt-8">
            <h3 class="font-semibold text-gray-900 dark:text-white mb-4">
              {t("footer.follow_us", locale)}
            </h3>
            <div class="flex gap-3">
              {
                socialMedia.map((social: any) => (
                  <a
                    href={social.url}
                    target="_blank"
                    rel="noopener"
                    class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center hover:bg-primary-500 dark:hover:bg-primary-600 hover:text-white dark:text-gray-200 transition-colors"
                    data-testid={`social-${social.platform.toLowerCase()}`}
                  >
                    <Icon name={social.icon} class="w-5 h-5" />
                  </a>
                ))
              }
            </div>
          </div>
        </div>

        <!-- Contact Form -->
        <div
          class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 transition-colors duration-200"
          data-testid="contact-form"
        >
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
            {t("contact.send_message", locale)}
          </h2>
          <form class="space-y-5" data-tenant-id={tenantId}>
            <div>
              <label
                for="name"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >{t("contact.name", locale)}</label
              >
              <input
                type="text"
                id="name"
                name="name"
                class="w-full px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 text-gray-900 dark:text-white focus:border-primary-500 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-900 outline-none transition-all"
                required
                data-testid="contact-input-name"
              />
            </div>
            <div>
              <label
                for="email"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >{t("contact.email", locale)}</label
              >
              <input
                type="email"
                id="email"
                name="email"
                class="w-full px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 text-gray-900 dark:text-white focus:border-primary-500 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-900 outline-none transition-all"
                required
                data-testid="contact-input-email"
              />
            </div>
            <div>
              <label
                for="subject"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >{t("contact.subject", locale)}</label
              >
              <input
                type="text"
                id="subject"
                name="subject"
                class="w-full px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 text-gray-900 dark:text-white focus:border-primary-500 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-900 outline-none transition-all"
                required
                data-testid="contact-input-subject"
              />
            </div>
            <div>
              <label
                for="message"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >{t("contact.message", locale)}</label
              >
              <textarea
                id="message"
                name="message"
                rows="5"
                class="w-full px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 text-gray-900 dark:text-white focus:border-primary-500 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-900 outline-none transition-all resize-none"
                required
                data-testid="contact-input-message"></textarea>
            </div>

            <!-- Turnstile Widget -->
            <div id="cf-turnstile-container" class="mt-4 min-h-[65px]"></div>

            <button
              type="submit"
              class="w-full btn-primary"
              data-testid="contact-submit-btn"
            >
              <Icon name="tabler:send" class="w-5 h-5 mr-2" />
              {t("contact.submit", locale)}
            </button>
          </form>
        </div>
      </div>

      <!-- Map -->
      <div
        class="mt-12 rounded-2xl overflow-hidden shadow-lg"
        data-testid="contact-map"
      >
        <iframe
          src={mapEmbed}
          width="100%"
          height="400"
          style="border:0;"
          allowfullscreen=""
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          title="Lokasi SMAN 2 Pangkalan Bun"></iframe>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { createScopedClient } from "../lib/supabase";
  console.log("[Kontak] Script initializing...");

  declare global {
    interface Window {
      showToast: (message: string, type: "success" | "error") => void;
      turnstile: {
        render: (
          element: string | HTMLElement,
          options: {
            sitekey: string;
            theme?: string;
            callback?: (token: string) => void;
          },
        ) => string;
        reset: (widgetId?: string) => void;
      };
      onloadTurnstileCallback: () => void;
    }
  }

  const form = document.querySelector("form");
  const submitBtn = form?.querySelector(
    'button[type="submit"]',
  ) as HTMLButtonElement;
  const originalBtnContent = submitBtn?.innerHTML;

  // Turnstile Setup
  const siteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
  let turnstileWidgetId: string | null = null;

  // Global callback for Turnstile
  window.onloadTurnstileCallback = function () {
    console.log("[Turnstile] Callback invoked. Checking prerequisites...");

    if (!siteKey) {
      console.error("[Turnstile] Site Key missing!");
      if (window.showToast)
        window.showToast("System Config Error: Turnstile Key Missing", "error");
      return;
    }

    const container = document.getElementById("cf-turnstile-container");
    if (!container) {
      console.error("[Turnstile] Container #cf-turnstile-container missing!");
      return;
    }

    // Check if already rendered to avoid duplicates or errors
    if (container.hasChildNodes()) {
      console.log(
        "[Turnstile] Container already has children. Skipping render.",
      );
      return;
    }

    if (window.turnstile) {
      try {
        console.log("[Turnstile] Rendering widget with sitekey:", siteKey);
        turnstileWidgetId = window.turnstile.render("#cf-turnstile-container", {
          sitekey: siteKey,
          theme: "light",
        });
        console.log(
          "[Turnstile] Widget rendered successfully, ID:",
          turnstileWidgetId,
        );
      } catch (e) {
        console.error("[Turnstile] Render error:", e);
      }
    } else {
      console.error(
        "[Turnstile] window.turnstile is undefined inside callback!",
      );
    }
  };

  // Turnstile Loader Logic
  const scriptId = "turnstile-api-script";
  let script = document.getElementById(scriptId) as HTMLScriptElement;

  if (!script) {
    console.log("[Turnstile] Script not found. Injecting...");
    script = document.createElement("script");
    script.id = scriptId;
    script.src =
      "https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback&render=explicit";
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  } else {
    console.log("[Turnstile] Script already exists.");
    // If script exists, turnstile might be ready or loading.
    if (window.turnstile) {
      console.log(
        "[Turnstile] window.turnstile exists. Manually triggering callback.",
      );
      window.onloadTurnstileCallback();
    } else {
      console.log(
        "[Turnstile] window.turnstile missing. Adding listener or waiting.",
      );
      // If script exists but turnstile obj doesn't, it might be loading.
      // We can listen for the load event if it hasn't fired, or poll.
      // Since we can't easily check if 'load' already fired on an existing script tag without a flag,
      // we'll try a short poll fallback.
      const checkInterval = setInterval(() => {
        if (window.turnstile) {
          console.log(
            "[Turnstile] window.turnstile appeared. Triggering callback.",
          );
          clearInterval(checkInterval);
          window.onloadTurnstileCallback();
        }
      }, 100);
      // Stop checking after 5 seconds
      setTimeout(() => clearInterval(checkInterval), 5000);
    }
  }

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!form || !submitBtn) return;

    const formData = new FormData(form);
    const tenantId = form.dataset.tenantId;
    const token = formData.get("cf-turnstile-response") as string;

    if (!tenantId) {
      window.showToast?.("System Error: Tenant ID missing.", "error");
      return;
    }

    const client = createScopedClient({ "x-tenant-id": tenantId }, import.meta.env);
    if (!client) {
      window.showToast?.("System Error: Supabase client missing.", "error");
      return;
    }

    if (!token) {
      window.showToast?.(
        "Mohon selesaikan verifikasi keamanan (CAPTCHA).",
        "error",
      );
      return;
    }

    // values
    const name = formData.get("name") as string;
    const email = formData.get("email") as string;
    const subject = formData.get("subject") as string;
    const message = formData.get("message") as string;

    try {
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending...`;

      // 1. Verify Turnstile
      const { data: verifyData, error: verifyError } =
        await client.functions.invoke("verify-turnstile", {
          body: { token },
        });

      if (verifyError || !verifyData?.success) {
        throw new Error("Verifikasi keamanan gagal. Silakan coba lagi.");
      }

      const ip_address = verifyData.ip;

      // 2. Insert Message
      const { error } = await client.from("contact_messages").insert({
        tenant_id: tenantId,
        name,
        email,
        subject,
        message,
        ip_address,
        status: "new",
      });

      if (error) throw error;

      window.showToast?.(
        "Pesan berhasil dikirim! Kami akan segera menghubungi Anda.",
        "success",
      );
      form.reset();

      // Reset turnstile
      if (window.turnstile && turnstileWidgetId)
        window.turnstile.reset(turnstileWidgetId);
    } catch (err: any) {
      console.error("Error sending message:", err);
      window.showToast?.(
        "Gagal mengirim pesan: " + (err.message || "Terjadi kesalahan sistem."),
        "error",
      );
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnContent || "Submit";
    }
  });
</script>
