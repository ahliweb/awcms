---
import WidgetWrapper from "~/components/ui/WidgetWrapper.astro";
import Headline from "~/components/ui/Headline.astro";
import { createScopedClient } from "~/lib/supabase";

const {
  title = "Visitor Statistics",
  subtitle,
  tagline,
  days = 30,
  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render("bg"),
} = Astro.props;

const locale = Astro.locals.locale ?? "en";
const tenantId = Astro.locals.tenant_id || null;
const runtimeEnv = Astro.locals.runtime?.env || import.meta.env;
const supabase = tenantId
  ? createScopedClient({ "x-tenant-id": tenantId }, runtimeEnv)
  : null;

const formatNumber = (value: number) =>
  new Intl.NumberFormat(locale).format(value || 0);
const daysNumber = Number(days) || 30;
const startDate = new Date();
startDate.setDate(startDate.getDate() - daysNumber + 1);
const startDateIso = startDate.toISOString().slice(0, 10);

let totals = {
  pageViews: 0,
  uniqueVisitors: 0,
  uniqueSessions: 0,
};

let topPages = [] as { path: string; count: number }[];

if (supabase && tenantId) {
  const { data, error } = await supabase
    .from("analytics_daily")
    .select("path, page_views, unique_visitors, unique_sessions, date")
    .gte("date", startDateIso);

  if (!error && data) {
    const pagesMap = new Map<string, number>();

    data.forEach((row) => {
      if (row.path === "__all__") {
        totals.pageViews += row.page_views || 0;
        totals.uniqueVisitors += row.unique_visitors || 0;
        totals.uniqueSessions += row.unique_sessions || 0;
        return;
      }

      const path = row.path || "/";
      pagesMap.set(path, (pagesMap.get(path) || 0) + (row.page_views || 0));
    });

    topPages = Array.from(pagesMap.entries())
      .map(([path, count]) => ({ path, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5);
  }
}

const stats = [
  {
    label: `Page Views (${daysNumber}d)`,
    value: formatNumber(totals.pageViews),
  },
  {
    label: `Unique Visitors (${daysNumber}d)`,
    value: formatNumber(totals.uniqueVisitors),
  },
  {
    label: `Sessions (${daysNumber}d)`,
    value: formatNumber(totals.uniqueSessions),
  },
];
---

<WidgetWrapper
  id={id}
  isDark={isDark}
  containerClass={`max-w-6xl mx-auto ${classes?.container ?? ""}`}
  bg={bg}
>
  <Headline
    title={title}
    subtitle={subtitle || `Last ${daysNumber} days`}
    tagline={tagline}
  />

  <div class="grid gap-6 md:grid-cols-3">
    {stats.map((stat) => (
      <div class="rounded-2xl border border-slate-200/70 bg-white/80 p-5 text-center shadow-sm backdrop-blur dark:border-slate-700/70 dark:bg-slate-900/70">
        <div class="text-xs uppercase tracking-[0.2em] text-slate-500 dark:text-slate-400">
          {stat.label}
        </div>
        <div class="mt-2 text-3xl font-semibold text-primary">
          {stat.value}
        </div>
      </div>
    ))}
  </div>

  {topPages.length > 0 ? (
    <div class="mt-8 rounded-2xl border border-slate-200/70 bg-white/80 p-6 shadow-sm dark:border-slate-700/70 dark:bg-slate-900/70">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold uppercase tracking-[0.2em] text-slate-500 dark:text-slate-400">
          Top Pages
        </h3>
        <span class="text-xs text-slate-400">Last {daysNumber} days</span>
      </div>
      <div class="mt-4 space-y-3">
        {topPages.map((page, index) => (
          <div class="flex items-center justify-between text-sm">
            <div class="flex items-center gap-3">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-slate-100 text-xs font-semibold text-slate-500 dark:bg-slate-800 dark:text-slate-300">
                {index + 1}
              </span>
              <span class="font-medium text-default">{page.path}</span>
            </div>
            <span class="text-slate-500 dark:text-slate-400">
              {formatNumber(page.count)} views
            </span>
          </div>
        ))}
      </div>
    </div>
  ) : null}
</WidgetWrapper>
