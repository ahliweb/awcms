---
/**
 * Dynamic Blog Route - Renders blogs from Supabase 'blogs' table
 * Path: /blogs/[slug]
 */
import type { GetStaticPaths } from "astro";
import Layout from "~/layouts/PageLayout.astro";
import { createClientFromEnv } from "~/lib/supabase";
import { getPublicTenantId } from "~/lib/publicTenant";
import { getBlogBySlug } from "~/lib/content";
import { Icon } from "astro-icon/components";
import { getLocale, t } from "~/utils/i18n";

export const prerender = true;

export const getStaticPaths = (async () => {
    const supabase = createClientFromEnv(import.meta.env);
    if (!supabase) return [];

    const { data, error } = await supabase
        .from("blogs")
        .select("slug")
        .eq("status", "published")
        .is("deleted_at", null);

    if (error) {
        console.error("[Blog] Error fetching blog slugs:", error.message);
        return [];
    }

    return (data || []).map((blog) => ({
        params: { slug: blog.slug },
    }));
}) satisfies GetStaticPaths;

// Get slug from URL
const { slug } = Astro.params;

const tenantId = getPublicTenantId();
const locale = getLocale(Astro.url);

// Create Supabase client
const supabase = createClientFromEnv(import.meta.env);

// Fetch blog data
const blog = slug && supabase ? await getBlogBySlug(supabase, slug, tenantId) : null;

if (!blog) {
    console.log(`[Blog] Blog not found: ${slug || "unknown"}`);
    Astro.response.status = 404;
}

// Format dates
const publishedDate = blog?.published_at
    ? new Date(blog.published_at)
    : new Date(blog?.created_at || Date.now());

const formattedDate = publishedDate.toLocaleDateString(locale, {
    year: "numeric",
    month: "long",
    day: "numeric",
});

// Metadata for SEO
const metadata = {
    title: blog?.title || "Blog not found",
    description: blog?.excerpt || "",
    openGraph: {
        type: "article",
        article: {
            publishedTime: blog.published_at,
            modifiedTime: blog.updated_at,
        },
        images: blog?.featured_image
            ? [{ url: blog.featured_image }]
            : undefined,
    },
};

// Content
const isVisual = blog?.editor_type === "visual";
const htmlContent = blog?.content || "";
---

<Layout metadata={metadata}>
    {blog ? (
        <article class="py-12 sm:py-16 lg:py-20">
            <div class="mx-auto max-w-4xl px-6 sm:px-8">
            <!-- Blog Header -->
            <header class="mb-8">
                <!-- Category Badge -->
                {
                    blog.category && (
                        <a
                            href={`/blogs?category=${blog.category.slug}`}
                            class="inline-block mb-4 px-3 py-1 text-sm font-medium rounded-full
                   bg-primary/10 text-primary hover:bg-primary/20 transition-colors"
                        >
                            {blog.category.name}
                        </a>
                    )
                }

                <!-- Title -->
                <h1
                    class="text-3xl md:text-4xl lg:text-5xl font-bold leading-tight tracking-tight dark:text-slate-200"
                >
                    {blog.title}
                </h1>

                <!-- Meta Info -->
                <div
                    class="mt-4 flex flex-wrap items-center gap-4 text-sm text-muted-foreground"
                >
                    <time
                        datetime={blog.published_at || blog.created_at}
                        class="flex items-center gap-1"
                    >
                        <Icon name="tabler:calendar" class="w-4 h-4" />
                        {formattedDate}
                    </time>

                    {
                        blog.views > 0 && (
                            <span class="flex items-center gap-1">
                                <Icon name="tabler:eye" class="w-4 h-4" />
                                {blog.views.toLocaleString()}{" "}
                                {t("blogs_page.blog.views", locale)}
                            </span>
                        )
                    }
                </div>

                <!-- Excerpt -->
                {
                    blog.excerpt && (
                        <p class="mt-6 text-xl text-muted-foreground dark:text-slate-400 leading-relaxed">
                            {blog.excerpt}
                        </p>
                    )
                }
            </header>

            <!-- Featured Image -->
            {
                blog.featured_image && (
                    <figure class="mb-10 -mx-6 sm:-mx-8 lg:-mx-16">
                        <img
                            src={blog.featured_image}
                            alt={blog.title}
                            class="w-full aspect-video object-cover rounded-none sm:rounded-xl shadow-lg"
                            loading="eager"
                        />
                    </figure>
                )
            }

            <!-- Blog Content -->
            {
                isVisual ? (
                    <div class="visual-content prose prose-lg dark:prose-invert max-w-none">
                        <p class="text-muted-foreground">
                            {t(
                                "blogs_page.blog.visual_content_placeholder",
                                locale,
                            )}
                        </p>
                    </div>
                ) : (
                    <div
                        class="prose prose-lg dark:prose-invert max-w-none
                 prose-headings:font-bold prose-headings:tracking-tight
                 prose-a:text-primary prose-a:no-underline hover:prose-a:underline
                 prose-img:rounded-xl prose-img:shadow-lg
                 prose-blockquote:border-l-primary prose-blockquote:bg-muted/50 prose-blockquote:py-1 prose-blockquote:px-4"
                        set:html={htmlContent}
                    />
                )
            }

            <!-- Blog Footer -->
            <footer class="mt-12 pt-8 border-t border-border">
                <!-- Tags -->
                {
                    blog.tags && blog.tags.length > 0 && (
                        <div class="flex flex-wrap gap-2 mb-6">
                            {blog.tags.map((tag) => (
                                <a
                                    href={`/blogs?tag=${tag.slug}`}
                                    class="px-3 py-1 text-sm rounded-full border border-border 
                       hover:bg-muted transition-colors"
                                >
                                    #{tag.name}
                                </a>
                            ))}
                        </div>
                    )
                }

                <!-- Back Link -->
                <a
                    href="/blogs"
                    class="inline-flex items-center gap-2 text-primary hover:underline"
                >
                    <Icon name="tabler:arrow-left" class="w-4 h-4" />
                    {t("blogs_page.blog.back_to_blogs", locale)}
                </a>
            </footer>
            </div>
        </article>
    ) : (
        <section class="py-12 sm:py-16 lg:py-20">
            <div class="mx-auto max-w-4xl px-6 sm:px-8">
                <h1 class="text-3xl font-semibold">Blog not found</h1>
                <p class="mt-4 text-muted-foreground">
                    The requested blog post could not be found.
                </p>
                <a
                    href="/blogs"
                    class="mt-6 inline-flex items-center gap-2 text-primary hover:underline"
                >
                    <Icon name="tabler:arrow-left" class="w-4 h-4" />
                    {t("blogs_page.blog.back_to_blogs", locale)}
                </a>
            </div>
        </section>
    )}
</Layout>
