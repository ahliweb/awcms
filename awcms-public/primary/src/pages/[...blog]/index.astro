---
import merge from 'lodash.merge';
import type { ImageMetadata } from 'astro';
import Layout from '~/layouts/PageLayout.astro';
import SinglePost from '~/components/blog/SinglePost.astro';
import ToBlogLink from '~/components/blog/ToBlogLink.astro';

import { getCanonical, getPermalink, trimSlash } from '~/utils/permalinks';
import { blogPostRobots, fetchPosts } from '~/utils/blog';
import { findImage } from '~/utils/images';
import type { MetaData } from '~/types';
import RelatedPosts from '~/components/blog/RelatedPosts.astro';

export const prerender = false;

const normalizedSlug = trimSlash(Astro.url.pathname);

const posts = await fetchPosts();
const post = posts.find(
  (entry) => trimSlash(entry.permalink) === normalizedSlug,
);

if (!post) {
  Astro.response.status = 404;
}

const url = post
  ? getCanonical(getPermalink(post.permalink, 'post'))
  : getCanonical('/');
const image = post
  ? ((await findImage(post.image)) as ImageMetadata | string | undefined)
  : undefined;

const metadata = merge(
  {
    title: post?.title || 'Post not found',
    description: post?.excerpt,
    robots: {
      index: blogPostRobots?.index,
      follow: blogPostRobots?.follow,
    },
    openGraph: {
      type: 'article',
      ...(image
        ? { images: [{ url: image, width: (image as ImageMetadata)?.width, height: (image as ImageMetadata)?.height }] }
        : {}),
    },
  },
  { ...(post?.metadata ? { ...post.metadata, canonical: post.metadata?.canonical || url } : {}) }
) as MetaData;
---

<Layout metadata={metadata}>
  {post ? (
    <>
      <SinglePost post={{ ...post, image: image }} url={url}>
        {post.Content ? <post.Content /> : <Fragment set:html={post.content || ''} />}
      </SinglePost>
      <ToBlogLink />
      <RelatedPosts post={post} />
    </>
  ) : (
    <section class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-4xl">
      <h1 class="text-3xl font-semibold">Post not found</h1>
    </section>
  )}
</Layout>
