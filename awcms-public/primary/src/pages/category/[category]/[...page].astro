---
import type { Taxonomy } from "~/types";
import { blogCategoryRobots, blogPostsPerPage, fetchPosts } from "~/utils/blog";
import { CATEGORY_BASE, trimSlash } from "~/utils/permalinks";
import { getLocale, t } from "~/utils/i18n";

import Layout from "~/layouts/PageLayout.astro";
import BlogList from "~/components/blog/List.astro";
import Headline from "~/components/blog/Headline.astro";
import Pagination from "~/components/blog/Pagination.astro";

export const prerender = false;

const getPageNumber = (value: string | string[] | undefined) => {
  if (!value) return 1;
  const raw = Array.isArray(value) ? value.join("/") : value;
  const lastSegment = raw
    .split("/")
    .map((segment) => segment.trim())
    .filter(Boolean)
    .at(-1);
  const parsed = Number.parseInt(lastSegment ?? "", 10);
  return Number.isNaN(parsed) || parsed < 1 ? 1 : parsed;
};

const categorySlug = Astro.params.category;
const currentPage = getPageNumber(Astro.params.page);
const locale = getLocale(Astro.request);

const posts = await fetchPosts();
const categories: Record<string, Taxonomy> = {};
posts.forEach((post) => {
  if (post.category?.slug) {
    categories[post.category.slug] = post.category;
  }
});

const category = categorySlug ? categories[categorySlug] : undefined;
const categoryTitle = category?.title || categorySlug || "";

const filteredPosts = posts.filter(
  (post) => post.category?.slug && post.category.slug === categorySlug,
);
const pageSize = blogPostsPerPage || 6;
const totalPages = Math.max(1, Math.ceil(filteredPosts.length / pageSize));
const safePage = Math.min(Math.max(currentPage, 1), totalPages);
const startIndex = (safePage - 1) * pageSize;
const pagePosts = filteredPosts.slice(startIndex, startIndex + pageSize);

const basePath = [CATEGORY_BASE || "category", categorySlug]
  .map((segment) => trimSlash(segment || ""))
  .filter(Boolean)
  .join("/");

const buildPageUrl = (pageNumber: number) =>
  pageNumber <= 1 ? basePath : `${basePath}/${pageNumber}`;

const prevUrl = safePage > 1 ? buildPageUrl(safePage - 1) : undefined;
const nextUrl = safePage < totalPages ? buildPageUrl(safePage + 1) : undefined;

if (!category) {
  Astro.response.status = 404;
}

const metadata = {
  title: `${t("blog_page.category.title_prefix", locale)} '${categoryTitle}' ${safePage > 1 ? `${t("blog_page.shared.page_prefix", locale)}${safePage}` : ""}`,
  robots: {
    index: blogCategoryRobots?.index,
    follow: blogCategoryRobots?.follow,
  },
};
---

<Layout metadata={metadata}>
  <section class="px-4 md:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-4xl">
    <Headline>{categoryTitle}</Headline>
    <BlogList posts={pagePosts} />
    <Pagination prevUrl={prevUrl} nextUrl={nextUrl} />
  </section>
</Layout>
