---
import Layout from '../layouts/Layout.astro';
import AWT01Layout from '../templates/awtemplate01/Layout.astro';
import { createScopedClient } from '../lib/supabase';
import { PuckRenderer } from '../components/PuckRenderer';


/**
 * Root Index Page
 * 
 * Serves the home page directly when tenant is resolved from host.
 * This avoids the /primary/ redirect for host-based tenant domains.
 */

// SSR Mode
export const prerender = false;

// Get Tenant Context from middleware
const { tenant_id, tenant_slug, runtime } = Astro.locals;
const env = runtime?.env || {};

// If no tenant context, something is wrong
if (!tenant_id || !tenant_slug) {
    console.error('[Index] No tenant context available');
    return new Response('Tenant Not Found', { status: 404 });
}

// Initialize Scoped Client
const supabase = createScopedClient({
    'x-tenant-id': tenant_id
}, env);

// Content Variables
let currentTemplateSlug = null;
let templateId = null;
let pageContent = null;
let meta = { title: 'Home', description: '' };
let mergedContent = [];
let errorState = null;

if (!supabase) {
    console.error('[Index] Critical: Supabase Client Failed to Initialize.');
    errorState = "Service Configuration Error";
    Astro.response.status = 500;
} else {
    try {
        // 1. Fetch Home Page
        const { data: pageData, error: pageError } = await supabase
            .from('pages')
            .select('*')
            .eq('slug', 'home')
            .eq('status', 'published')
            .maybeSingle();

        if (pageError) throw pageError;

        // 2. Fetch Template Assignments
        const { data: assignments, error: assignmentError } = await supabase
            .from('template_assignments')
            .select('route_type, template_id')
            .eq('channel', 'web')
            .in('route_type', ['home', '404']);
            
        if (assignmentError) console.warn('[Index] Template Assignment Fetch Warning:', assignmentError);

        const assignmentMap: Record<string, string> = {};
        (assignments || []).forEach(a => assignmentMap[a.route_type] = a.template_id);

        if (pageData) {
            meta.title = pageData.meta_title || pageData.title || 'Home';
            meta.description = pageData.meta_description;
            pageContent = pageData.puck_layout_jsonb || { content: [], root: {} };

            if (pageData.template && pageData.template !== 'default') {
                templateId = pageData.template;
            } else {
                templateId = assignmentMap['home'];
            }
        } else {
            // No home page, use template default
            templateId = assignmentMap['home'];
        }

        // 3. Fetch Template & Parts
        if (templateId) {
            const { data: template, error: templateError } = await supabase
                .from('templates')
                .select('*')
                .eq('id', templateId)
                .maybeSingle();
            
            if (templateError) console.warn('[Index] Template Fetch Warning:', templateError);

            if (template) {
                currentTemplateSlug = template.slug;
                const parts = template.parts || {};
                const partIds = Object.values(parts).filter(Boolean);
                
                const partDataMap: Record<string, any> = {};
                if (partIds.length > 0) {
                    const { data: partsData } = await supabase
                        .from('template_parts')
                        .select('*')
                        .in('id', partIds);
                        
                    (partsData || []).forEach(p => partDataMap[p.id] = p);
                }

                if (parts.header && partDataMap[parts.header]) {
                     const headerContent = partDataMap[parts.header].data?.content || [];
                     mergedContent.push(...headerContent);
                }

                const pageHasContent = pageContent && pageContent.content && pageContent.content.length > 0;
                
                if (pageHasContent) {
                     mergedContent.push(...pageContent.content);
                } else {
                     const templateContent = template.data?.content || [];
                     mergedContent.push(...templateContent);
                }

                if (parts.footer && partDataMap[parts.footer]) {
                     const footerContent = partDataMap[parts.footer].data?.content || [];
                     mergedContent.push(...footerContent);
                }
            } else {
                if (pageContent) mergedContent = pageContent.content || [];
            }
        } else {
            if (pageContent) mergedContent = pageContent.content || [];
        }

    } catch (err: any) {
        console.error('[Index] Render Error:', err);
        errorState = err.message || "Unknown Render Error";
        Astro.response.status = 500;
    }
}

const finalPuckData = {
    content: mergedContent,
    root: { title: meta.title, props: {} }
};

const LayoutComponent = (currentTemplateSlug === 'awtemplate01') ? AWT01Layout : Layout;

// For host-based resolution, use root paths (no tenant prefix)
const layoutProps = {
    title: meta.title,
    description: meta.description,
    tenantSlug: '' // Empty = no prefix in URLs
};
---

<LayoutComponent {...layoutProps}>
  <main>
    {errorState ? (
        <div class="container mx-auto py-20 text-center text-red-600">
            <h1 class="text-4xl font-bold mb-4">500 - Server Error</h1>
            <p class="font-mono bg-gray-100 p-4 rounded inline-block text-left text-sm text-gray-800">
                {errorState}
            </p>
        </div>
    ) : (
        <>
            {finalPuckData.content.length > 0 ? (
            <PuckRenderer data={finalPuckData} />
            ) : (
            <div class="container mx-auto py-20 text-center">
                <p>No content found.</p>
            </div>
            )}
        </>
    )}
  </main>
</LayoutComponent>
